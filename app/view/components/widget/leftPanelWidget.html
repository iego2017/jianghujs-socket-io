<!-- 左边栏 -->
<script type="text/x-template" id="_LeftPanel">
  <div>
    <v-scroll-x-transition>
      <v-navigation-drawer
        app
        width="285"
        class="navigation-drawer mob-app-left"
        v-show="!isMobile || (isMobile && !mobileLeftHide)"
        permanent
        touchless
      >
        <!--   用户信息   -->
        <LeftUserWidget @userinfo_menu_click="onUserWidgetMenuClick" />

        <LeftNoticeWidget/>

        <!--   聊天菜单等   -->
        <LeftDrawerMenu
          :menuIndex="menuIndex"
          :count="leftTabcount"
          @change="onLeftMenuChange"
        />
        <v-list class="leftDataList" ref="leftDataList">
          <v-list-item-group
            :value="nowChatSessionId"
            @change="onLeftItemChange"
            color="primary"
            active-class
            class="listItem"
          >
            <div class="searchAndNewFriendBox">
              <v-text-field
                label="搜索"
                clearable
                dense
                v-model="searchKeyword"
                hide-details
                prepend-inner-icon="mdi-text-search"
                class="ma-2 pa-0"
                outlined
              ></v-text-field>
              <v-btn
                v-if="menuIndex === 1 && newFriendRequestCount"
                outlined
                :block="!isMobile"
                color="red darken-3"
                class="newFriendBtn"
                @click="openRequestFriendDialog"
              >新朋友（{{ newFriendRequestCount }}）</v-btn>
            </div>
            <template v-if="leftDataList.length">
              <template v-for="(item, index) in leftDataList">
                <div :data-index="index"
                     :hidden="isHidden(item)"
                     :key="`${index}_${item.chatId}`">
                  <v-list-item-content
                    v-if="item.dataListSubTitle === 'botListStart'"
                    class="pa-0 ma-0">
                    <v-subheader>
                      <div class="d-flex" style="width: 100%; cursor: pointer;" @click="toggleCollapseStatus">
                        <span style="line-height: 24px">机器人</span>
                        <v-spacer></v-spacer>
                        <v-icon v-if="!collapseStatus">mdi-chevron-down</v-icon>
                        <v-icon v-else>mdi-chevron-up</v-icon>
                      </div>
                    </v-subheader>
                  </v-list-item-content>
                  <v-list-item-content
                    v-else-if="item.dataListSubTitle === 'chatSessionStart'"
                    class="pa-0 ma-0">
                    <v-subheader >聊天</v-subheader>
                  </v-list-item-content>
                  <v-list-item-content
                    v-else-if="item.dataListSubTitle === 'friendListStart'"
                    class="pa-0 ma-0">
                    <v-subheader >好友</v-subheader>
                  </v-list-item-content>
                  <v-list-item-content
                    v-else-if="item.dataListSubTitle === 'userRoomRoleListStart' && canRender(index)"
                    class="pa-0 ma-0">
                    <v-subheader>群组</v-subheader>
                  </v-list-item-content>
                  <v-list-item
                    v-else-if="canRender(index)"
                    class="pa-0 ma-0"
                    :value="getDataId(item)"
                    :class="{ 'activeItem': isActiveItem(item), 'isTopChat': !isRobot(item) && checkIsTop(item) }"
                    @click="doUiAction('mobileShowChattingPage', { isRobot: isRobot(item), friendDeviceId: item.friendDeviceId })"
                  >
                    <LeftBotWidget
                      v-if="menuIndex === 0 && isRobot(item)"
                      :data="item"
                      @delete="onDeleteData"
                    />
                    <ChatWidget
                      v-else-if="menuIndex === 0"
                      :isOnline="isOnline(item.chatId)"
                      @onClearUnread="delMessageOffline"
                      @toggleMuted="onChatMuted"
                      :ref="'chatWidget_' + getDataId(item)"
                      :data="item"
                    />
                    <FriendWidget
                      v-if="menuIndex === 1 && item.friendId"
                      :data="item"
                    />
                    <RoomWidget
                      v-if="menuIndex === 1 && item.roomId"
                      :data="item"
                    />
                  </v-list-item>
                  <div v-else class="leftDataListItemEmpty d-flex" style="height: 70px">
                    <div class="empty_avatar ma-2"></div>
                    <div class="empty_chatInfos d-flex">
                      <div class="empty_title ma-2"></div>
                      <div class="empty_message ma-2"></div>
                    </div>
                  </div>
                </div>
              </template>
            </template>
            <template v-else>
              <div style="width: 100%; line-height: 100px; text-align: center;">
                {{ menuIndex === 0 ? '暂无信息' : '开发中...' }}
              </div>
            </template>
          </v-list-item-group>
        </v-list>
      </v-navigation-drawer>
    </v-scroll-x-transition>
    <RequestFriendDialog
      v-model="requestFriendState"
      @acceptRequest="onAcceptRequest"
      :requestFriendList="requestFriendList"
    />
    <InputDialog
      v-model="inputDialog"
      :ctrl-type="inputDialogType"
      @done="searchByKeyword"
    />
    <EditUserAvatarDialog
      v-model="editUserAvatarDialog"
      :user="user"
      @refreshUserInfo="doUiAction('getUserInfo')"
    />
    <EditPasswordDialog v-model="editPasswordDialog" />
     <!-- 建群选择框 -->
    <SelectFriend v-model="leftSelectFriend" ctrl-type="createRoom" :friends="myFriendListBackUps"
      @done="onSelectFriend" />
    <!-- 群发选择框 -->
    <SelectFriend ref="selectMultiSend" v-model="selectMultiSend" :show-all-room="true" :show-all-friend="true"
      :show-input="true" :ctrl-type="friendListCtrlType" :friends="friendAndRoomMergedList" @done="onSelectMultiSend" />
  </div>
</script>


<script>
  window.registerData(
    {
      nowChatSessionId: null,
      friendListCtrlType: '',
      selectMultiSend: false,
      leftSelectFriend: false,
      editPasswordDialog: false, // 修改密码弹出框
      editUserAvatarDialog: false, // 修改用户头像弹出框
      isMuted: webOptions('isMuted') || false, // 消息静音，系统
      // 移动端适配使用
      mobileLeftHide: false, // 移动端左侧列表显示控制
      leftListScrollTop: 0,
      leftListScrollHeight: 0,
      mutedIdList: [],
      menuIndex: 0, // 菜单
      searchKeyword: null,
      inputDialog: false, // 输入框弹窗
      inputDialogType: 'searchAccount',
      requestFriendList: [],
      collapseStatus: webOptions('collapseStatus') || false,
      buildTime: +new Date(),
      requestFriendState: false // 显示好友申请列表
    },
    {
      chatSessionListAndBotList() {
        return [
          { dataListSubTitle: 'botListStart' },
          ...this.botList,
          { dataListSubTitle: 'chatSessionStart' },
          ...this.chatList
        ];
      },
      friendListAndUserRoomRoleList() {
        return [
          { dataListSubTitle: 'friendListStart' },
          ...this.myFriendList,
          { dataListSubTitle: 'userRoomRoleListStart' },
          ...this.userRoomRoleList
        ];
      },
      // 左侧列表数据
      leftDataList() {
        const aiList = [];
        return [ this.chatSessionListAndBotList, this.friendListAndUserRoomRoleList, aiList ][
          this.menuIndex
        ];
      },
      // 左上侧数量统计
      leftTabcount() {
        return [
          [ this.chatList, [ ...this.myFriendList, ...this.userRoomRoleList ], this.botList ][
            this.menuIndex
          ].length,
          this.chatList.filter(item => !!item.offlineMessageCount).length
        ];
      },
      // 好友申请数量
      newFriendRequestCount() {
        return this.requestFriendList.filter(v => {
          if (v.friendStatus === 'waitingApprove') {
            return true;
          }
          return false;
        }).length;
      }
    }
  )


  Vue.component('LeftPanel', {
    template: '#_LeftPanel',
    mixins: [ window.jianghuUiActionMixins ],
    data: () => window.vueData,
    vueComponent: 'leftPanel',
    computed: window.vueComputed,
    props: {
    },
    watch: {
      searchKeyword(value) {
        this.doUiAction('reFilterList', value)
      },
      nowChatSessionId(value) {
      },
      isMuted(value) {
        console.log('静音', value);
      },
      dataSyncStatus: {
        deep: true,
        handler(value) {
        }
      }
    },
    mounted() { },
    async created() {
      this.initLeftDataListScroll();
      this.getUserFriendRequest();
      this.getChatSessionList({ type: 'created' });
      this.getFriendList();
      this.getUserBotList();
    },
    methods: {
      // 展开或者收起
      toggleCollapseStatus() {
        this.collapseStatus = !this.collapseStatus;
        webOptions('collapseStatus', this.collapseStatus);
        // 强制刷新，无视key
        this.buildTime = +new Date();
        console.log(this.collapseStatus);
      },
      isHidden(item) {
        return this.collapseStatus && this.menuIndex === 0 && this.isRobot(item);
      },
      isActiveItem(item) {
        if (item.friendDeviceId === undefined) {
          return this.friendDeviceId == null && this.nowChatSessionId === getDataId(item);
        }
        return this.friendDeviceId === item.friendDeviceId && this.nowChatSessionId === getDataId(item)

      },
      isRobot(item) {
        return !!item.friendDeviceType;
      },
      canRender(index) {
        // 收起的情况下，有把index向上移动机器人数量
        if (this.collapseStatus && this.menuIndex === 0) {
          // index 包含机器人和聊天的标题，故大于length正好
          if (index > this.botList.length) {
            return (index - this.botList.length) * 70 >= this.leftListScrollTop - 210 && (index - this.botList.length) * 70 <= this.leftListScrollTop + this.leftListScrollHeight + 210;
          }
        }
        return index * 70 >= this.leftListScrollTop - 210 && index * 70 <= this.leftListScrollTop + this.leftListScrollHeight + 210;
      },
      // 通过robot列表，过滤掉已经是机器人的回话，避免出现两次
      reFilterChatSessionByRobot() {
        // 从聊天列表中过滤掉机器人
        this.chatList = this.chatList.filter(item => {
          const botIncludeChat = this.botList.some(bot => {
            if (bot.friendId === item.chatId) {
              Object.assign(bot, item);
              return true;
            }
            return false;
          });
          return !botIncludeChat;
        });
        this.updateNowChatItemInfo();
      },
      // 从新加载玩chatSessionList后，更新当前激活中的chatItem 和 id
      async updateNowChatItemInfo () {
        if (this.chatSessionListAndBotList.length > 2) {
          if (_.isEmpty(this.nowChatSessionId) && !this.isMobile) {
            // 第一条是分组标题，如果第二条是聊天的分组标题，就是没有小程序，直接取第三条
            let firstChat = this.chatSessionListAndBotList[1];
            if (firstChat.dataListSubTitle) {
              firstChat = this.chatSessionListAndBotList[2];
            }
            await this.$nextTick(() => {
              // 默认选中第一条
              if (this.isRobot(firstChat)) {
                this.friendDeviceId = firstChat.friendDeviceId;
              }
              this.nowChatSessionId = firstChat.chatId || firstChat.friendId;
              this.nowChatItem = firstChat;
            });
          } else {
            if (this.isChat) {
              // 同步nowChatSessionId
              if (!this.chatSessionListAndBotList.some(item => (item.chatId || item.friendId) === this.nowChatSessionId)) {
                this.nowChatSessionId = null;
                this.nowChatItem = null;
              }
            }
          }
        } else {
          this.nowChatSessionId = null;
          this.nowChatItem = null;
        }
      },
      // 获取会话列表
      async getChatSessionList({ type }) {
        this.chatListBackUps = (
          await window.jianghuAxios({
            data: {
              appData: {
                pageId: 'chat',
                actionId: 'getChatSession',
                mark: type
              }
            }
          })
        ).data.appData.resultData.rows;

        this.chatListBackUps.forEach(item => {
          try {
            if (item.chatRoomExtend) {
              item.chatRoomExtend = JSON.parse(item.chatRoomExtend);
            } else {
              item.chatRoomExtend = {};
            }
          } catch (error) {
            item.chatRoomExtend = {};
          }
        });
        this.chatList = this.chatListBackUps.slice();
        this.doUiAction('reFilterList')
        this.reFilterChatSessionByRobot();
        // APP同步免打扰列表
        if (isApp) {
          // 静音的IdList
          this.mutedIdList = this.chatListBackUps
            .filter(v => {
              return !!v.muted;
            })
            .map(v => v.chatId);
          // 推送到APP端，后台服务同样静默
          appPostMessage({
            action: 'syncMutedChatIdList',
            mutedIdList: this.mutedIdList
          });
        }
      },
      // 获取好友列表
      async getFriendList() {
        const newMyFriendList = (
          await window.jianghuAxios({
            data: {
              appData: {
                pageId: 'chat',
                actionId: 'getUserFriend'
              }
            }
          })
        ).data.appData.resultData.rows;
        sortList(newMyFriendList, 'friendUsername');
        const newMyFriendListBackUps = newMyFriendList.slice();
        this.myFriendList = newMyFriendList;
        this.myFriendListBackUps = newMyFriendListBackUps;
        if (this.isFriend && !newMyFriendList.some(item => item.friendId === this.nowChatSessionId)) {
          this.nowChatSessionId = ''
        }
        this.doUiAction('getRoomInfo');
        this.reFilterRobot();
      },
      // 根据好友列表过滤，只保留是自己好友的小程序
      reFilterRobot () {
        // 过滤，只保留是好友关系的小程序
        if (!this.myFriendListBackUps.length) {
          return;
        }
        let newBotList = this.botListBackUps.slice();
        const friendIDObj = {}
        this.myFriendListBackUps.forEach(item => {
          friendIDObj[item.friendId] = true
        })
        // 把自己也放进去
        const userId = localStorage.getItem(window.appInfo.appId + '_userId');
        friendIDObj[userId] = true;
        newBotList = newBotList.filter(item => friendIDObj[item.friendId])
        sortList(newBotList, 'friendUsername');
        this.botList = newBotList
      },
      async getUserBotList() {
        const rows = (
          await window.jianghuAxios({
            data: {
              appData: {
                pageId: 'chat',
                actionId: 'getUserBotList'
              }
            }
          })
        ).data.appData.resultData.rows;
        this.botListBackUps = rows.map(row => {
          return {
            friendId: row.userId,
            friendUsername: row.username,
            friendUserAvatar: row.userAvatar,
            friendUserIp: row.userIp,
            friendDeviceType: row.deviceType,
            friendDeviceId: row.deviceId,
            xiaochengxuIndexPage: row.xiaochengxuIndexPage,
          }
        })
        if (this.isXiaochengxu && !this.botListBackUps.some(item => item.userId === this.nowChatSessionId)) {
          this.$emit('nowChatSessionId', '')
        }
        this.reFilterRobot();
        this.reFilterChatSessionByRobot(this.botListBackUps.length);
      },
      updateChatListItem(params) {
        // 更新完整数据表
        let nowIndex = this.chatListBackUps.findIndex(v => {
          return v.chatId === this.getDataId(params);
        });
        if (nowIndex >= 0) {
          for (const key of Object.keys(params)) {
            if (params[key]) {
              this.chatListBackUps[nowIndex][key] = params[key];
            }
          }
        }
        // 更新当前UI显示的数据表
        nowIndex = this.chatList.findIndex(v => {
          return v.chatId === this.getDataId(params);
        });
        if (nowIndex >= 0) {
          for (const key of Object.keys(params)) {
            if (params[key]) {
              this.chatList[nowIndex][key] = params[key];
            }
          }
        }
      },

      // 搜索好友，打开好友信息弹框
      async searchByKeyword(keyword) {
        const account = (
          await window.jianghuAxios({
            data: {
              appData: {
                pageId: 'chat',
                actionId: 'getUserInfo',
                where: {
                  userId: keyword
                }
              }
            }
          })
        ).data.appData.resultData.rows[0];
        if (account) {
          this.searchUserUid = account.userId;
          this.accountDialog = true;
          this.doUiAction('pushState', { path: 'searchByKeyword' })
        } else {
          window.vtoast.fail('未搜索到用户');
        }
      },
      openMultiSendDialog() {
        this.friendListCtrlType = 'multiSend';
        this.doUiAction('pushState', { path: 'multiSend' })
        this.selectMultiSend = !this.selectMultiSend;
        this.$refs.selectMultiSend.selectedItem = [];
        window.history.back();
      },
      async onSelectMultiSend(targets, message) {
        let sendCount = 0;
        for (const target of targets) {
          if (target.friendId) {
            await this.methods.sendMsg(
              {
                messageContent: message,
                messageContentType: duoxingMessageContentTypeEnum.text,
                targetUserId: target.friendId
              },
              false,
              2
            );
          } else {
            await this.methods.sendMsg(
              {
                messageContent: message,
                messageContentType: duoxingMessageContentTypeEnum.text,
                targetUserId: target.roomId
              },
              false,
              1
            );
          }
          sendCount += 1;
          if (sendCount % 10 === 0) {
            window.vtoast.success(
              `群发消息中 - ${sendCount}/${targets.length} ...`
            );
          }
        }
        window.vtoast.success(`群发消息完成，共 ${targets.length} 条`);
      },
      // 当左侧菜单切换
      onLeftMenuChange(index) {
        this.doUiAction('pushState', { path: [ 'chatList', 'friendList', 'roomList', 'botList' ][index] })
        if (this.menuIndex !== index) {
          this.searchKeyword = null;
          this.menuIndex = index;
          if (index == 0) {
            this.getChatSessionList({ type: 'onLeftMenuChange' });
          }
          if (index == 1) {
            this.getFriendList();
            this.getUserFriendRequest();
            this.doUiAction('getUserInfo')
          }
          if (index == 2) {
            this.getUserBotList();
          }
        }
      },

      async onSelectFriend(friends) {
        await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'chat',
              actionId: 'createRoom',
              actionData: {
                roomUserIdList: friends.map(v => v.friendId)
              }
            }
          }
        });
        this.doUiAction('getUserInfo')
      },

      // 当创建群聊
      onCreateRoom() {
        this.friendListCtrlType = 'createRoom';
        this.leftSelectFriend = true;
        this.doUiAction('pushState', { path: 'createRoom' })
      },

      /**
       * 已读
       * @param chatId
       * @return {Promise<void>}
       */
      async delMessageOffline(chatId) {
        const clickChatSession = this.chatListBackUps.find(
          chatSession => chatSession.chatId === chatId
        );
        if (clickChatSession && clickChatSession.offlineMessageCount) {
          clickChatSession.offlineMessageCount = 0;
          await window.jianghuAxios({
            data: {
              appData: {
                pageId: 'chat',
                actionId: 'delMessageOffline',
                actionData: {
                  messageType: clickChatSession.messageType,
                  userIdOrRoomId: `${chatId}`
                }
              }
            }
          });
        }
      },
      // 获取好友申请列表
      async getUserFriendRequest() {
        this.requestFriendList = (
          await window.jianghuAxios({
            data: {
              appData: {
                pageId: 'chat',
                actionId: 'getUserFriendRequest'
              }
            }
          })
        ).data.appData.resultData.rows;
      },
      /**
       * 事件回调
       * @param value
       */
      // 左侧点击
      onLeftItemChange(value) {
        if (!value) return false;
        const findNowChatItem = this.leftDataList.find(v => {
          return getDataId(v) === value;
        });
        if (findNowChatItem) {
          this.nowChatItem = findNowChatItem;
          this.nowChatSessionId = getDataId(findNowChatItem);
        }
        return true;
      },
      /**
       * 当左侧列表开始滑动
       * @param event
       */
      leftListOnScroll(event) {
        if (this.willRanderLeftListTimer) {
          clearTimeout(this.willRanderLeftListTimer);
        }
        this.willRanderLeftListTimer = setTimeout(() => {
          this.leftListScrollTop = this.$refs.leftDataList.$el.scrollTop;
          this.leftListScrollHeight = this.$refs.leftDataList.$el.offsetHeight;
          console.log(this.leftListScrollHeight);
        }, 60);
      },
      /**
       * 绑定左侧的上下滑动
       */
      initLeftDataListScroll() {
        try {
          this.$nextTick(() => {
            this.leftListScrollTop = this.$refs.leftDataList.$el.scrollTop;
            this.leftListScrollHeight =
              this.$refs.leftDataList.$el.offsetHeight;
            this.$refs.leftDataList.$el.onscroll = this.leftListOnScroll;
          });
        } catch (e) {
          requestAnimationFrame(() => {
            this.initLeftDataListScroll();
          });
        }
      },
      // 仅限于聊天置顶, 其他两项不需要置顶
      checkIsTop(item) {
        if (!this.menuIndex) {
          return !!item.topChatOrder;
        }
        return false;
      },
      /**
       * 检查用户在线状态
       * @param chatId
       */
      isOnline(chatId) {
        const findFriendFromFriendListWhereChatId =
          this.myFriendListBackUps.find(friend => friend.friendId === chatId);
        if (findFriendFromFriendListWhereChatId) {
          return findFriendFromFriendListWhereChatId.isOnline;
        }
        return false;
      },

      onChatMuted(toggleMutedChatId) {
        const key = Object.keys(toggleMutedChatId)[0];
        const value = toggleMutedChatId[key];
        if (value) {
          this.mutedIdList.push(key);
        } else {
          this.mutedIdList = this.mutedIdList.filter(v => v !== key);
        }
        appPostMessage({
          action: 'syncMutedChatIdList',
          mutedIdList: this.mutedIdList
        });
        // this.mutedIdList
      },
      /**
       * 互动方法
       */
      openRequestFriendDialog() {
        if (this.newFriendRequestCount) {
          this.requestFriendState = true;
        }
      },
      // 当添加好友
      onAddFriend() {
        this.inputDialog = true;
        this.doUiAction('pushState', { path: 'addFriend' })
      },
      // 当左侧三列数据进行删除操作
      async onDeleteData(id) {
        await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'chat',
              actionId: 'delUserFriend',
              actionData: {
                friendId: id
              }
            }
          }
        });
        this.getFriendList()
      },

      onAcceptRequest() {
        this.requestFriendState = false;
        this.getUserFriendRequest();
        this.getFriendList()
      },
      closeAllDialog() {
        this.accountDialog = false;
        this.requestFriendState = false;
        this.leftSelectFriend = false;
        this.selectMultiSend = false;
        this.inputDialog = false;
        this.editUserAvatarDialog = false;
        this.editPasswordDialog = false;
      },

      // 左上角用户的操作菜单
      async onUserWidgetMenuClick(e) {
        // eslint-disable-next-line default-case
        switch (e) {
          case 1: {
            this.searchUserUid = this.user.userId;
            this.accountDialog = true;
            this.doUiAction('pushState', { path: 'editUserInfo' })
            break;
          }
          case 2: {
            this.editUserAvatarDialog = true;
            this.doUiAction('pushState', { path: 'editUserAvatarDialog' })
            break;
          }
          case 5: {
            this.editPasswordDialog = true;
            this.doUiAction('pushState', { path: 'editPasswordDialog' })
            break;
          }
          case 10: {
            await window.jianghuAxios({
              data: {
                appData: {
                  pageId: 'allPage',
                  actionId: 'logout',
                  actionData: { needSetCookies: true }
                }
              }
            });
            localStorage.removeItem(window.appInfo.appId + '_userInfo');
            localStorage.removeItem(window.appInfo.appId + '_authToken');
            localStorage.removeItem(window.appInfo.appId + '_refreshToken');
            location.href = `/${window.appInfo.appId}/page/login`;
            appPostMessage({ action: 'userLogout' });
            break;
          }
          case 15: {
            window.location.href = location.href;
            break;
          }
          case 20: {
            appPostMessage({ action: 'showAppInfo' });
            break;
          }
        }
      }
    }
  });
</script>
