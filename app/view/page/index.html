{% extends 'template/duoxingTemplate.html'%}

<!-- vue template 代码块 -->
{% block vue_template %}
<v-app id="inspire">
  <!-- 左边栏 -->
  <left-panel ref="leftPanel" />
  <!-- 中间栏目 -->
  <v-main class="chatMain mob-app-main">
    <chatting-page :sessionId="currentChatSessionId" ref="chattingPage" />
  </v-main>

  <!-- 消息输入框 -->
  <v-footer
    app inset fixed color="transparent"
    :height="isMobile ? (textareaExpanded ? 106 : 53) : 274"
    class="vFooter ma-0 pa-0 mob-app-footer"
    :class="{ 'mobExpandChat': mobExpandChat }"
  >
    <chat-input-widget ref="chatInput" />
  </v-footer>
</v-app>
{% endblock %}

<!-- vue script 代码块 -->
<!-- 注意：本项目的 vue 为每个页面使用一个 vue 实例 -->
{% block vue_body %}

<!--加载聊天列表相关组件 >>>>>>>>>>>> -->
{% include 'components/widget/leftUserWidget.html' %}
{% include 'components/widget/leftChatSessionWidget.html' %}
{% include 'components/widget/leftPanelWidget.html' %}
<!--<<<<<<<<<<<< 加载聊天列表相关组件 -->

<!--加载聊天详情相关组件 >>>>>>>>>>>> -->
{% include 'components/widget/middleChatInputWidget.html' %}
{% include 'components/widget/middleChatMessageWidget.html' %}
{% include 'components/widget/loadMore.html' %}
<!--<<<<<<<<<<<< 加载聊天详情相关组件 -->

<!--加载消息条相关组件 >>>>>>>>>>>> -->
{% include 'components/message/imageMessage.html' %}
{% include 'components/message/fileMessage.html' %}
{% include 'components/message/textMessage.html' %}
<!--<<<<<<<<<<<< 加载消息条相关组件 -->

<!--加载发信息相关组件 >>>>>>>>>>>> -->
{% include 'components/common/emotion.html' %}
<!--<<<<<<<<<<<< 加载发信息相关组件 -->

<script type="module">
window.registerData(
  {
    isMobile: window.innerWidth < 500,
    messageTextareaValue: '',
    currentChatSessionId: null,
    currentChatSession: null,
    chatList: [],
    socketClient: window.socket,
    userInfo: window.userInfo,
    dataSyncStatus: {
      color: 'amber darken-1',
      label: '同步中...'
    },
    currentResendMsg: {},
    mobileMessageTextareaFocus: false // 移动端适配使用的消息输入框焦点状态
  },
  {
    socketStatus() {

      const label = ['连接成功', '连接中...', '连接断开'][this.isSocketOnline || 0];
      const color = ['green accent-3', 'amber darken-1', 'deep-orange accent-3'][this.isSocketOnline || 0];
      return {label, color};
    },
    isSocketOnline() {
      if (this.socketClient && this.socketClient.online === false) {
        return 2;
      }
      if (this.socketClient && this.socketClient.online === true) {
        return 0;
      }
      return 1;
    },
    mobileLeftHide() {
      return !this.currentChatSessionId
    },
    // 指示移动端时是否展开消息输入框
    mobExpandChat() {
      if (this.$vuetify.breakpoint.xs) {
        return this.mobileMessageTextareaFocus;
      }
      return true;
    },
    sendMsgActionId() {
      return this.currentChatSession && this.currentChatSession.messageType === 'room'
        ? 'userSendMessageToRoom'
        : 'userSendMessageToUser';
    }
  }
)

const didaAudio = new Audio(
  '/<$ ctx.app.config.appId $>/public/audio/dida.wav'
);
new Vue({
  el: '#app',
  template: '#app-template',
  vuetify: new Vuetify(),
  mixins: [window.jianghuUiActionMixins],
  data: () => window.vueData,
  vueComponent: 'root',
  computed: window.vueComputed,
  components: {},
  async created() {
    // 手机端，除了输入框，其他地方禁止系统菜单
    this.doUiAction('setSyncStatusToSyncing');
    this.doUiAction('disableSystemEvent');
    this.doUiAction('initWebSocket');
    await this.doUiAction('getChatSessionList');
    this.doUiAction('setSyncStatusToSuccess');
  },
  watch: {
    async currentChatSessionId(v) {
      this.messageTextareaValue = null;
    },
  },
  methods: {
    getDataId(item) {
      if (item) {
        return item.chatId || item.toRoomId || (item.fromUserId === this.userInfo.userId ? item.toUserId : item.fromUserId) || item.roomId || item.friendId;
      }
      return null;
    },
    setSyncStatusToSyncing() {
      this.dataSyncStatus = {
        color: 'amber darken-1',
        label: '同步中...'
      }
      window.sync = {
        ing: true
      };
    },
    setSyncStatusToSuccess() {
      this.dataSyncStatus = {
        color: 'green accent-3',
        label: '同步成功'
      }
      console.log('setSyncStatusToSuccess', this.dataSyncStatus)
      window.sync.ing = false;
    },
    // ✅禁止系统菜单和文字选中
    disableSystemEvent() {
      document.oncontextmenu = function () {
        event.returnValue =
          !this.isMobile ||
          (this.isMobile &&
            (event.target.localName === 'textarea' || event.target.localName === 'input'));
      };
      document.onselectstart = function () {
        event.returnValue =
          !this.isMobile ||
          (this.isMobile &&
            (event.target.localName === 'textarea' || event.target.localName === 'input'));
      };
    },

    /** 初始化socket */
    initWebSocket() {
      this.socketClient.init();
      this.socketClient.addListeners('reConnect', result => this.doUiAction('onSocketReConnect', result));
      this.socketClient.addListeners('userNotice', result => this.doUiAction('onUserNotice', result));
      this.socketClient.addListeners('userMessage', result => this.doUiAction('onUserMessage', result));
      this.socketClient.addListeners('roomNotice', result => this.doUiAction('onRoomNotice', result));
      this.socketClient.addListeners('roomMessage', result => this.doUiAction('onRoomMessage', result));
    },

    async getUserInfo() {
      await refreshUserInfo();
    },

    /**
     * 已读
     * @return {Promise<void>}
     */
    async delMessageOffline() {
      if (this.chatList) {
        const clickChatSession = this.chatList.find(chatSession => chatSession.chatId === this.currentChatSessionId);
        if (clickChatSession && clickChatSession.offlineMessageCount) {
          clickChatSession.offlineMessageCount = 0;
          await window.jianghuAxios({
            data: {
              appData: {
                pageId: 'chat',
                actionId: 'delMessageOffline',
                actionData: {
                  messageType: clickChatSession.messageType,
                  userIdOrRoomId: this.currentChatSessionId
                }
              }
            }
          });
        }
      }
    },

    // 过滤和排序列表
    reFilterList() {
      // chatList 也要重排
      if (this.chatList) {
        this.chatList = this.chatList.map(chatItem => {
          chatItem.orderCompare = chatItem.messageTimeString;
          return chatItem;
        })
        this.chatList.sort((a, b) => {
          return b.orderCompare.localeCompare(a.orderCompare);
        });
      }
    },
    preventDefault,
    /**
     * 断线重连监听
     * @param hasDisconnectOrError
     * @param hasDisconnectOrError.hasError
     */
    async onSocketReConnect({hasError}) {
      if (hasError) {
        this.doUiAction('setSyncStatusToSyncing')
        await this.doUiAction('getUserInfo');
        await this.doUiAction('getChatSessionList', {type: 'onSocketReConnect'});
        this.doUiAction('setSyncStatusToSuccess')
      }
    },


    onUserNotice(result) {
      this.handleNoticeMessage(result);
      this.renderChatSession(result);
      this.renderNoticeUI(result);
    },
    onRoomNotice(result) {
      this.handleNoticeMessage(result);
      this.renderChatSession(result);
      this.renderNoticeUI(result);
    },
    onUserMessage(result) {
      this.handleNoticeMessage(result);
      this.renderChatSession(result);
    },
    onRoomMessage(result) {
      this.handleNoticeMessage(result);
      this.renderChatSession(result);
    },

    // 更新左侧列表的聊天内容和顺序
    async renderChatSession(params) {
      // 更新chatList 中的数据
      this.doUiAction("updateChatListItem", {params});
      // 消息在左侧列表，并且不是正在聊天中，更新左侧列表对应消息，上下下线的通知不渲染
      if (params.noticeType !== 'errorNotice') {
        if (this.existChatSession(params)) {
          // 重排后再更新会话显示，否则会有取不到会话的情况
          this.reFilterList();
          // 更新未读消息
          this.updateMessageCount(params);
        } else {
          // 消息不带头像，需要更新聊天会话列表，避免没头像
          await this.doUiAction('getChatSessionList', {type: '消息不带头像，需要更新聊天会话列表，避免没头像'});
        }
      }
      this.chatList = _.cloneDeep(this.chatList);
      if (this.getDataId(params) === this.currentChatSessionId) {
        this.doUiAction('scrollToBottom')
      }
      // 渲染聊天内容
      if (this.$root.getDataId(params) === this.currentChatSessionId) {
        this.doUiAction('updateMessageItem', {
          message: params
        });
      }
      return null;
    },

    updateChatListItem({params}) {
      // 更新当前UI显示的数据表
      const nowIndex = this.chatList.findIndex(v => {
        return v.chatId === this.$root.getDataId(params);
      });
      if (nowIndex >= 0) {
        for (const key of Object.keys(params)) {
          if (params[key]) {
            this.chatList[nowIndex][key] = params[key];
          }
        }
      }
    },

    /**
     * 更新未读消息
     * @param params
     */
    updateMessageCount(params) {
      //如果不是是自己发的消息，未读+1
      if (params.fromUserId !== this.userInfo.userId) {
        this.chatList = this.chatList.map(v => {
          const findSessionByParams = v.chatId === this.$root.getDataId(params);
          if (findSessionByParams) {
            v.offlineMessageCount += 1;
          }
          return v;
        });
      }
    },

    renderNoticeUI(params) {
      if (params.hasOwnProperty('noticeType')) {
        if (
          params.noticeType === 'errorNotice' &&
          params.errorCode === 'chat_not_user_friend'
        ) {
          this.doUiAction('updateMessageItem', {
            message: {
              ...params.errorReasonSupplement,
              loading: false,
              error: true
            }
          });
        }
      }
    },

    /**
     * 判断消息是否在聊天列表中
     * @param params
     */
    existChatSession(params) {
      const dataId = this.$root.getDataId(params);
      return this.chatList.some(chat => this.$root.getDataId(chat) === dataId);
    },

    /** 播放消息提示音 **/
    async playBeep() {
      try {
        await this.playBeepConfirm();
      } catch (e) {
        if (await window.confirmDialog({
          title: '您的网页无法自动播放消息提示音，需要确认后播放',
          titleClass: 'text-body-1'
        })) {
          this.playBeepConfirm();
        }
      }
    },

    /** 确认消息提示音 */
    playBeepConfirm() {
      didaAudio.play();
    },

    /**
     * 通知处理
     * @param params
     */
    handleNoticeMessage(params) {
      // 通知类
      if (params.noticeType) {
        if (!!params.messageContent) {
          // 更新上下线状态改变
          const excludeNoticeType = ['onlineNotice', 'offlineNotice'];
          if (excludeNoticeType.includes(params.noticeType)) {
            this.setOnlineStatus(params);
            return;
          }
          // 显示通知
          this.showNotify(getMessageContent(params), '通知')
        }
        return;
      }
      // 消息类，不是自己发送的消息, 不是通知类消息
      if (params.fromUserId !== this.userInfo.userId) {
        this.showNotify(`【您有一条新消息】${params.fromUsername}："${getMessageContent(params, true)}"`, '新消息')
      }
    },

    /**
     * 用户上下线状态改变
     * @param params
     */
    setOnlineStatus(params) {
      this.chatList.some(item => {
        if (item.chatId === this.getDataId(params)) {
          item['isOnline'] = params.noticeType === 'onlineNotice';
        }
      })
    },

    /**
     * 消息提醒
     * @param msg
     * @param title
     */
    showNotify(msg, title) {
      // 显示通知
      window.vtoast.showAndNotify({
        message: msg,
        title: title
      });
      // 未静音，播放消息提示音
      this.playBeep();
    },
    prepareSendMsgValidata({messageContent, messageContentType}) {
      // 不在线，不发送
      if (window.socket && window.socket.online === false) {
        window.vtoast.fail('离线中...，请稍后尝试发送');
        throw new Error('离线中...，请稍后尝试发送');
      }
      // 超过7000个字，不发送
      if (messageContent.length > 7000 && messageContentType === 'text') {
        window.vtoast.fail('消息内容长度不得超过7000个文字', false, 'bottom');
        throw new Error('消息内容长度不得超过7000个文字');
      }
      // 消息内容为空
      if (messageContentType === 'text' && !messageContent) {
        window.vtoast.fail('消息内容为空', false, 'bottom');
        throw new Error('消息内容为空');
      }
    },
    async sendMsg(
      {
        messageContent = this.messageTextareaValue || '',
        messageContentType = 'text',
        messageFingerprint = uuid(),
        file = null,
        targetUserId = null
      }
    ) {
      this.prepareSendMsgValidata({messageContent, messageContentType});

      const socketParams = {
        messageContent,
        messageContentType,
        toUserId: targetUserId || this.currentChatSessionId,
        toRoomId: targetUserId || this.currentChatSessionId,
        messageFingerprint
      };
      const tempParams = {
        ...socketParams,
        fromUserId: this.userInfo.userId,
        fromUsername: this.userInfo.username,
        fromUserAvatar: this.userInfo.userAvatar,
        loading: true,
        process: 0
      };
      // 先更新一个 loading 消息
      this.doUiAction('updateMessageItem', {
        message: tempParams
      });
      this.doUiAction('scrollToBottom')
      setTimeout(
        () => {
          if (tempParams.loading === true) {
            tempParams.loading = false;
            tempParams.error = true;
          }
        },
        file ? 5000000 : 10000
      );

      if (file) {
        const uploadResult = await this.uploadFileMsg(
          file,
          tempParams,
          socketParams
        );
        const uploadFail = !uploadResult ||
          !uploadResult.data.appData.resultData.filename ||
          !uploadResult.data.appData.resultData.downloadPath ||
          !uploadResult.data.appData.resultData.binarySize;
        if (uploadFail) {
          this.doUiAction('updateMessageItem', {
            message: {
              ...tempParams,
              loading: false,
              error: true
            },
            insert: false
          });
        } else {
          const {filename, downloadPath, binarySize} = uploadResult.data.appData.resultData;
          socketParams.messageContent = JSON.stringify({
            filename,
            downloadPath,
            binarySize
          });
          await window.socket.emitMsg({
            actionData: socketParams,
            actionId: this.sendMsgActionId
          });
        }
      } else {
        await window.socket.emitMsg({
          actionData: socketParams,
          actionId: this.sendMsgActionId
        });
      }
      this.$forceUpdate();
      // 成功后
      // console.log('socketParams', socketParams);
      this.messageTextareaValue = '';
      window.vtoast.dismiss();
      this.doUiAction('scrollToBottom', {mustToBottom: true})
    },
    /**
     * 获取发送消息socket actionID
     * @param forwardType
     */
    async uploadFileMsg(
      file,
      tempParams,
      socketParams
    ) {
      let uploadResult;
      const fileDirectory = `${this.userInfo.userId || 'chatFile'}/${new Date().getFullYear()}/${new Date().getMonth() + 1}/${new Date().getDate()}/`;
      // 文件流
      if (file) {
        try {
          // 使用 progress-linear https://vuetifyjs.com/zh-Hans/components/progress-linear/#section-989c8272
          const that = this
          this.doUiAction('updateMessageItem', {
            message: {
              ...tempParams,
              progress: 1
            },
            insert: false
          });
          uploadResult = await window.jianghuAxios.httpUploadByStream({
            file, fileDirectory,
            onProgress: (total, loaded) => {
              let progress = Number((loaded * 100 / total).toFixed(2))
              if (progress == 100) {
                progress = 99
              }
              that.doUiAction('updateMessageItem', {
                message: {
                  ...tempParams,
                  progress
                },
                insert: false
              });
            }
          })
        } catch (err) {
          console.log(err)
        }
        this.doUiAction('updateMessageItem', {
          message: {
            ...tempParams,
            progress: 100
          },
          insert: false
        });
      }
      return uploadResult;
    },
  }
});
</script>
<style>
.v-snack--top {
  top: 60px !important;
}

.navigation-drawer .v-navigation-drawer__content {
  display: flex;
  flex-direction: column;
}


.chatMain {
  box-sizing: border-box;
  height: 100vh;
  background: #f5f7fa;
}

.navigation-drawer {
  max-height: 100vh !important;
  overflow: hidden !important;
}


.vFooter .chatToolbar {
  height: 50px !important;
  flex: 1;
}

.vFooter .chatToolbar .v-toolbar__content {
  height: 50px !important;
}

.v-navigation-drawer__content {
  overflow: hidden !important;

}

.text-body-2 {
  width: 100%;
  height: 100%;
}

.text-body-2 .v-input {
  font-size: 14px;
}

.text-body-2 .v-text-field {
  border: 2px solid #ffffff;
  border-radius: 4px;
}

.text-body-2 .v-text-field.error--text {
  border: 2px solid #ff5252;
  border-radius: 4px;
}

.fileInput {
  opacity: 0;
  width: 0;
  height: 0;
  position: absolute;
  top: -10000px;
}

.footer {
  width: 100%;
  border-top: 1px solid #cccccc;
  height: 100%;
  background-color: #fff;
}

.v-input__slot::before,
.v-input__slot::after {
  content: none !important;
}

.nickname {
  font-size: 14px;
  line-height: 1.5rem
}

.leftDataList {
  flex: 1;
  -webkit-overflow-scrolling: touch;
}

.leftDataList::-webkit-scrollbar {
  width: 5px;
}

.leftDataList::-webkit-scrollbar-track {
  width: 5px;
  background-color: #F1F1F1;
}

.leftDataList::-webkit-scrollbar-thumb {
  width: 3px;
  background-color: #E1E1E1;
  border-radius: 3px;
}

.leftDataList .activeItem .chatItem {
  background-color: var(--primaryColorA80) !important;
}

.leftDataList .activeItem {
  background-color: #ffffff !important;
  position: relative;
  overflow: hidden;
}

.message {
  position: relative;
  overflow: hidden;
  border-radius: 5px;
  background: #FFFFFF;
  font-size: 14px;
  padding: 10px;
  align-content: start;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
}

.message .progress {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 2;
}

.flex-row-around {
  flex-direction: row;
  justify-content: space-around;
  align-items: center;
}


.v-badge__badge {
  z-index: 3;
}


.playIcon::before {
  content: "\F1591";
  display: inline-block;
  font: normal normal normal 24px/1 "Material Design Icons";
  font-size: 18px;
  text-rendering: auto;
  line-height: inherit;
  -webkit-font-smoothing: antialiased;
  color: green;
  transform: translate(5px, 2px);
}


@media screen and (max-width: 600px) {
  .leftDataList {
    height: calc(100vh - 180px) !important;
    -webkit-overflow-scrolling: touch;
    overflow-scrolling: touch;
  }

  .mob-app-left {
    width: 100% !important;
  }

  .emotionContainer {
    width: 100% !important;
    height: 223px !important;
  }

  .mobExpandChat .emotionContainer .arrow {
    right: 58px !important;
  }

  .emotionContainer .arrow {
    left: auto !important;
    right: 42px !important;
  }

  .fileContent {
    max-width: 230px !important;
    overflow: hidden !important;
  }

  .fileContentFileDesc {
    display: inline-block !important;
    font-size: 12px !important;
  }

  .mob-app-main {
    padding-left: 0 !important;
    padding-right: 0 !important;
  }

  .mob-app-footer {
    left: 0 !important;
    right: 0 !important;
  }

  .footer {
    border: 0 !important;
  }

  .text-body-2 textarea::-webkit-scrollbar,
  .text-body-2 textarea::-webkit-scrollbar-track,
  .text-body-2 textarea::-webkit-scrollbar-thumb {
    width: 0 !important;
  }

  .text-body-2 textarea {
    padding: 7px 5px 0 !important;
    height: 70px !important;
    line-height: 1.6 !important;
    overflow: auto !important;
  }

  .text-body-2 .v-text-field {
    max-height: 100%;
  }

  .v-input--dense > .v-input__control > .v-input__slot {
    margin-bottom: 0 !important;
  }

  .v-application .v-input {
    font-size: 12px !important;
  }

  .v-application .text-body-2 {
    border: 1px solid #EEEEEE !important;
    border-radius: 4px !important;
    overflow: hidden !important;
    padding: 0 !important;
    margin: 0 !important;
    font-size: 12px !important;
  }

  .v-application .error--text .theme--light.v-counter {
    transform: translateX(-3px);
  }

  .v-application .error--text .v-messages__message {
    zoom: 0.9;
    transform: translateX(5px);
  }

  .newMsgCount {
    bottom: 139px !important;
  }


}
</style>
{% endblock %}
